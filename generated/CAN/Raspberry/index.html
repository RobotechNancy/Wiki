<!DOCTYPE html>

<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Wiki Robotech Nancy - Librairie Raspberry</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Utiliser la librairie CAN pour Raspberry">

		<link rel="stylesheet" href="http://127.0.0.1:8000/static/style.css">
		<link rel="apple-touch-icon" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="icon" type="image/webp" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700&display=swap">
	</head>

	<body>
		<header>
			<h1>
				<a href="http://127.0.0.1:8000/">
					<img src="http://127.0.0.1:8000/static/images/icons/logo.webp" width="40" height="40" alt="Logo Robotech Nancy">
					<span>Wiki Robotech Nancy</span>
				</a>
				<button type="button" class="open-nav" aria-label="Ouvrir la navigation" onclick="document.body.classList.toggle('nav-open')"></button>
			</h1>

			<nav>
				<div>
					
    

    <a href="http://127.0.0.1:8000/Cartes/">Cartes utilisées</a>
    

    <a href="http://127.0.0.1:8000/Wiki/">Modifier ce wiki</a>
    

    <details>
        <summary>Build avec CMake</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CMake/Installation/">Installer CMake</a>
    

    <a href="http://127.0.0.1:8000/CMake/Executable/">Créer un exécutable</a>
    

    <a href="http://127.0.0.1:8000/CMake/Lier/">Lier des librairies</a>
    

    <a href="http://127.0.0.1:8000/CMake/Librairie/">Créer une librairie</a>
    

        </div>
    </details>
    

    <details>
        <summary>Projets STM32</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/STM32/Installation/">Installation</a>
    

    <a href="http://127.0.0.1:8000/STM32/Projet/">Créer un projet</a>
    

    <a href="http://127.0.0.1:8000/STM32/CubeMX/">Configurer une carte</a>
    

        </div>
    </details>
    

    <details>
        <summary>Bus CAN</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/CAN/Raspberry/">Librairie Raspberry</a>
    

    <a href="http://127.0.0.1:8000/CAN/STM32/">Librairie STM32</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Librairie/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Modules XBee</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/XBee/Librairie/">Utiliser la librairie</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Initialisation/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Odométrie</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Odometrie/ArUCO/">Marqueurs ArUCO</a>
    

    <a href="http://127.0.0.1:8000/Odometrie/Optique/">Capteur optique</a>
    

        </div>
    </details>
    

    <details>
        <summary>Signaux PWM</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/STM32/">STM32</a>
    

    <details>
        <summary>PCA9685</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/PCA9685/Librairie/">Utiliser la librairie</a>
    

    <a href="http://127.0.0.1:8000/PWM/PCA9685/Implementation/">Implémentation</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

				</div>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>CAN/Raspberry</h2>
				<h3 class="no-anchor">Librairie Raspberry</h3>
			</div>
			<article class="content">
				<p>Pour installer la librairie CAN sur Linux, il faut :</p>
<ul>
<li>Cloner le dépôt GitHub : <code>git clone https://github.com/RobotechNancy/Communication.git</code></li>
<li>Se placer dans le dossier cloné : <code>cd Communication</code></li>
<li>Utiliser le script d'installation : <code>sudo ./lib_manager install Logs CAN</code></li>
</ul>
<blockquote>
<p class="quote quote-TIP">Pour mettre à jour la librairie, <code>git pull</code> puis <code>sudo ./lib_manager install CAN</code></p>
</blockquote>
<h3>Configuration du bus</h3>
<p>Avant d'utiliser la librairie CAN, il est important de créer l'interface CAN :</p>
<ul>
<li>Bus CAN virtuel :</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1"># Ajouter le module vcan</span>
sudo<span class="w"> </span>modprobe<span class="w"> </span>vcan
<span class="c1"># Créer l&#39;interface vcan0</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>dev<span class="w"> </span>vcan0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>vcan
</code></pre></div>

<ul>
<li>Bus CAN réel :</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1"># Ajouter le module mcp2515</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;dtoverlay=mcp2515-can0,oscillator=8000000,interrupt=25,spimaxfrequency=2000000&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>/boot/config.txt
<span class="c1"># Redémarrer la Raspberry</span>
sudo<span class="w"> </span>reboot
</code></pre></div>

<h3>Initialisation</h3>
<p>Pour initialiser un module CAN, il faut créer une instance de la classe <code>CAN</code> et lui attribuer une adresse :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="n">CAN</span><span class="w"> </span><span class="n">can</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">can</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">CAN_ADDR_RASPBERRY</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Une erreur s&#39;est produite lors de l&#39;initialisation</span>
<span class="w">    </span><span class="c1">// Toutes les erreurs sont définies dans define_can.h</span>
<span class="p">}</span>
</code></pre></div>

<p>Important, il faut démarrer l'interface CAN avant de pouvoir l'utiliser :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1"># Démarrer l&#39;interface vcan0</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>up<span class="w"> </span>vcan0

<span class="c1"># Démarrer l&#39;interface can0</span>
sudo<span class="w"> </span>ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>can0<span class="w"> </span>up<span class="w"> </span><span class="nb">type</span><span class="w"> </span>can<span class="w"> </span>bitrate<span class="w"> </span>&lt;BITRATE&gt;<span class="w"> </span>loopback<span class="w"> </span>off
</code></pre></div>

<h3>Envoyer des données</h3>
<p>Pour envoyer une données, il suffit d'utiliser <code>CAN::send</code> :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="n">can</span><span class="p">.</span><span class="n">send</span><span class="p">(</span>
<span class="w">    </span><span class="n">CAN_ADDR_ODOMETRIE</span><span class="p">,</span><span class="w">     </span><span class="c1">// Receveur</span>
<span class="w">    </span><span class="n">FCT_ACCUSER_RECEPTION</span><span class="p">,</span><span class="w">  </span><span class="c1">// Fonction</span>
<span class="w">    </span><span class="p">{</span><span class="mh">0x01</span><span class="p">},</span><span class="w">                 </span><span class="c1">// Données</span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                      </span><span class="c1">// ID de la demande (arbitraire)</span>
<span class="w">    </span><span class="nb">false</span><span class="w">                   </span><span class="c1">// Demande =&gt; false</span>
<span class="p">);</span>
</code></pre></div>

<h3>Recevoir des données</h3>
<p>Il existe deux manières de recevoir des données :</p>
<ul>
<li>De manière synchrone (bloque le programme), avec <code>CAN::send</code> :</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="n">can_result_t</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">can2</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">CAN_ADDR_RASPBERRY</span><span class="p">,</span><span class="w"> </span><span class="n">FCT_ACCUSER_RECEPTION</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mh">0x01</span><span class="p">},</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">CAN_OK</span><span class="p">:</span>
<span class="w">        </span><span class="c1">// Trame accessible dans res.frame</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;CAN_OK&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">CAN_ERROR</span><span class="p">:</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;CAN_ERROR&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">CAN_TIMEOUT</span><span class="p">:</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;CAN_TIMEOUT&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li>De manière asynchrone (ne bloque pas le programme), avec <code>CAN::bind</code> :</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">handleAcknowledge</span><span class="p">(</span><span class="n">CAN</span><span class="w"> </span><span class="o">&amp;</span><span class="n">can</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">can_frame_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x01</span><span class="p">)</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ACK&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;NACK&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">can</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">FCT_ACCUSER_RECEPTION</span><span class="p">,</span><span class="w"> </span><span class="n">handleAcknowledge</span><span class="p">);</span>
</code></pre></div>

<p>Dans les deux cas, il est nécessaire d'appeler <code>CAN::startListening</code> pour démarrer l'écoute :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;robotech/xbee.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CAN</span><span class="w"> </span><span class="n">can</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">can</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">CAN_ADDR_RASPBERRY</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Utilisation d&#39;un lambda au lieu d&#39;une fonction classique</span>
<span class="w">    </span><span class="n">can</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">FCT_ACCUSER_RECEPTION</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="n">CAN</span><span class="w"> </span><span class="o">&amp;</span><span class="n">can</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">can_frame_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Code fonction ACCUSER_RECEPTION reçu&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="n">can</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">senderAddress</span><span class="p">,</span><span class="w"> </span><span class="n">FCT_ACCUSER_RECEPTION</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// On bloque le thread principal pour laisser le </span>
<span class="w">    </span><span class="c1">// temps au programme de recevoir des meesages</span>
<span class="w">    </span><span class="n">can</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
			</article>
		</section>

		<script src="http://127.0.0.1:8000/static/script.js"></script>
	</body>
</html>