<!DOCTYPE html>

<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Wiki Robotech Nancy - Format des trames</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Documentation sur le format de trames">

		<link rel="stylesheet" href="http://127.0.0.1:8000/static/style.css">
		<link rel="apple-touch-icon" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="icon" type="image/webp" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700&display=swap">
	</head>

	<body>
		<header>
			<h1>
				<a href="http://127.0.0.1:8000/">
					<img src="http://127.0.0.1:8000/static/images/icons/logo.webp" width="40" height="40" alt="Logo Robotech Nancy">
					<span>Wiki Robotech Nancy</span>
				</a>
				<button type="button" class="open-nav" aria-label="Ouvrir la navigation" onclick="document.body.classList.toggle('nav-open')"></button>
			</h1>

			<nav>
				<div>
					
    

    <a href="http://127.0.0.1:8000/Cartes/">Cartes utilisées</a>
    

    <a href="http://127.0.0.1:8000/Wiki/">Modifier ce wiki</a>
    

    <details>
        <summary>Build avec CMake</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CMake/Installation/">Installer CMake</a>
    

    <a href="http://127.0.0.1:8000/CMake/Executable/">Créer un exécutable</a>
    

    <a href="http://127.0.0.1:8000/CMake/Lier/">Lier des librairies</a>
    

    <a href="http://127.0.0.1:8000/CMake/Librairie/">Créer une librairie</a>
    

        </div>
    </details>
    

    <details>
        <summary>Projets STM32</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/STM32/Installation/">Installation</a>
    

    <a href="http://127.0.0.1:8000/STM32/Projet/">Créer un projet</a>
    

    <a href="http://127.0.0.1:8000/STM32/CubeMX/">Configurer une carte</a>
    

        </div>
    </details>
    

    <details>
        <summary>Bus CAN</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/CAN/Raspberry/">Librairie Raspberry</a>
    

    <a href="http://127.0.0.1:8000/CAN/STM32/">Librairie STM32</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Librairie/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Modules XBee</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/XBee/Librairie/">Utiliser la librairie</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Initialisation/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Odométrie</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Odometrie/ArUCO/">Marqueurs ArUCO</a>
    

    <a href="http://127.0.0.1:8000/Odometrie/Optique/">Capteur optique</a>
    

        </div>
    </details>
    

    <details>
        <summary>Signaux PWM</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/STM32/">STM32</a>
    

    <details>
        <summary>PCA9685</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/PCA9685/Librairie/">Utiliser la librairie</a>
    

    <a href="http://127.0.0.1:8000/PWM/PCA9685/Implementation/">Implémentation</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

				</div>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>CAN/Implementation/Format</h2>
				<h3 class="no-anchor">Format des trames</h3>
			</div>
			<article class="content">
				<p>On utilise le protocole <code>2.0b</code> est utilisé pour avoir une trame applicative sur 29 bits (au lieu de 11) et jusqu'à 8 octets de données :</p>
<table tabindex='0'>
<thead>
<tr>
<th style="text-align: left;">Champ</th>
<th style="text-align: center;">EMIT_ADDR</th>
<th style="text-align: center;">RECV_ADDR</th>
<th style="text-align: center;">FCT_CODE</th>
<th style="text-align: center;">MSG_ID</th>
<th style="text-align: center;">IS_RESP</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Nombre de bits</td>
<td style="text-align: center;">8 (0-255)</td>
<td style="text-align: center;">8 (0-255)</td>
<td style="text-align: center;">8 (0-255)</td>
<td style="text-align: center;">4 (0-15)</td>
<td style="text-align: center;">1 (0-1)</td>
</tr>
<tr>
<td style="text-align: left;">Description</td>
<td style="text-align: center;">Adresse de l'emetteur</td>
<td style="text-align: center;">Adresseur du receveur</td>
<td style="text-align: center;">Fonction à réaliser</td>
<td style="text-align: center;">ID de la trame applicative</td>
<td style="text-align: center;">Réponse ou non</td>
</tr>
</tbody>
</table>
<p>Les controlleurs CAN (MCP2515 ou celui intégré aux L432KC) ne supportent que les protocoles CAN 2.0 et CAN 2.0b avec 8 octets de données.
Seuls les messages valides activent les interruptions, les autres sont ignorés.</p>
<p>Tous les masques, décalages et autres constantes sont définies dans <code>define_can.h</code>.
Le filtrage des adresses est fait par la librairie et utilise ces constantes :</p>
<ul>
<li>Dans <code>CAN::readBuffer</code> côté Raspberry :</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="n">frame</span><span class="p">.</span><span class="n">receiverAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">can_id</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CAN_MASK_RECEIVER_ADDR</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">CAN_OFFSET_RECEIVER_ADDR</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">receiverAddress</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">receiverAddress</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CAN_ADDR_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li>Dans <code>CAN_RECEIVE</code> côté STM32 :</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="n">rep</span><span class="o">-&gt;</span><span class="n">receiverAddress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">RxHeader</span><span class="p">.</span><span class="n">ExtId</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">CAN_MASK_RECEIVER_ADDR</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">CAN_OFFSET_RECEIVER_ADDR</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">receiverAddress</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NODE_ADDRESS</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">receiverAddress</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">CAN_ADDR_BROADCAST</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">HAL_ERROR</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Pour mieux comprendre les masques et décalages, voici un schéma : </p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1">// Initialement, on a une séquence de 29 bits</span>
<span class="mb">0b11001111000110001000001100001</span>

<span class="c1">// Si on veut récupérer l&#39;adresse de l&#39;émetteur, on applique un masque</span>
<span class="w">   </span><span class="mb">0b11001111000110001000001100001</span><span class="w"> </span>
<span class="o">&amp;</span><span class="w">  </span><span class="mb">0b11111111000000000000000000000</span>
<span class="o">----------------------------------</span>
<span class="o">=</span><span class="w">  </span><span class="mb">0b11001111000000000000000000000</span>

<span class="c1">// Ensuite on veut se débarasser des 21 bits de poids faible</span>
<span class="w">   </span><span class="mb">0b11001111000000000000000000000</span>
<span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">21</span>
<span class="o">----------------------------------</span>
<span class="o">=</span><span class="w">  </span><span class="mb">0b00000000000000000000011001111</span>

<span class="c1">// Enfin, on stocke le résultat dans une variable</span>
<span class="c1">// qui ne prend que 8 bits, ce qui revient à</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b11001111</span><span class="p">;</span>
</code></pre></div>
			</article>
		</section>

		<script src="http://127.0.0.1:8000/static/script.js"></script>
	</body>
</html>