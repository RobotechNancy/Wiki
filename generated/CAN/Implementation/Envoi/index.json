{
    "hidden": "false",
    "title": "Envoi de donn\u00e9es",
    "description": "Impl\u00e9mentation de l'envoi de donn\u00e9es",
    "order": "4",
    "uri": "CAN/Implementation/Envoi",
    "page_content": "<h3>C\u00f4t\u00e9 STM</h3>\n<p>L'envoi de donn\u00e9es utilise la fonction <code>HAL_CAN_AddTxMessage</code>:</p>\n<div class=\"codehilite\"><pre tabindex='0'><span></span><code><span class=\"c1\">// Donn\u00e9es \u00e0 envoyer</span>\n<span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{...};</span>\n\n<span class=\"c1\">// Structure de la trame</span>\n<span class=\"n\">CAN_TxHeaderTypeDef</span><span class=\"w\"> </span><span class=\"n\">txHeader</span><span class=\"p\">;</span>\n\n<span class=\"n\">txHeader</span><span class=\"p\">.</span><span class=\"n\">DLC</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">length</span><span class=\"p\">;</span><span class=\"w\">                  </span><span class=\"c1\">// Longueur des donn\u00e9es</span>\n<span class=\"n\">txHeader</span><span class=\"p\">.</span><span class=\"n\">IDE</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">CAN_ID_EXT</span><span class=\"p\">;</span><span class=\"w\">              </span><span class=\"c1\">// Trame \u00e9tendue</span>\n<span class=\"n\">txHeader</span><span class=\"p\">.</span><span class=\"n\">RTR</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">CAN_RTR_DATA</span><span class=\"p\">;</span><span class=\"w\">            </span><span class=\"c1\">// La trame contient des donn\u00e9es</span>\n<span class=\"n\">txHeader</span><span class=\"p\">.</span><span class=\"n\">TransmitGlobalTime</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">DISABLE</span><span class=\"p\">;</span><span class=\"w\">  </span><span class=\"c1\">// Pas de timestamp</span>\n\n<span class=\"c1\">// On remplit la trame \u00e9tendue avec notre trame applicative</span>\n<span class=\"n\">txHeader</span><span class=\"p\">.</span><span class=\"n\">ExtId</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">canAddress</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">CAN_OFFSET_EMIT_ADDR</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\">                    </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">CAN_OFFSET_RECEIVER_ADDR</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\">                    </span><span class=\"n\">functionCode</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">CAN_OFFSET_FUNCTION_CODE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\">                    </span><span class=\"n\">messageID</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">CAN_OFFSET_MESSAGE_ID</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\">                    </span><span class=\"n\">isResponse</span><span class=\"p\">;</span>\n\n<span class=\"c1\">// La mailbox permet d&#39;envoyer plusieurs trames en m\u00eame temps</span>\n<span class=\"c1\">// On ne s&#39;en sert pas ici</span>\n<span class=\"kt\">uint32_t</span><span class=\"w\"> </span><span class=\"n\">TxMailbox</span><span class=\"p\">;</span>\n\n<span class=\"n\">HAL_CAN_AddTxMessage</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">hcan1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">txHeader</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">TxMailbox</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<h3>C\u00f4t\u00e9 Raspberry</h3>\n<p>C\u00f4t\u00e9 Raspberry, l'envoi est quasi identique \u00e0 STM32 :</p>\n<div class=\"codehilite\"><pre tabindex='0'><span></span><code><span class=\"n\">std</span><span class=\"o\">::</span><span class=\"n\">vector</span><span class=\"o\">&lt;</span><span class=\"kt\">uint8_t</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{...};</span>\n\n<span class=\"n\">can_frame</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">{};</span>\n<span class=\"n\">buffer</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">();</span>\n\n<span class=\"c1\">// On copie les donn\u00e9es dans le buffer</span>\n<span class=\"n\">memcpy</span><span class=\"p\">(</span><span class=\"n\">buffer</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">());</span>\n\n<span class=\"n\">buffer</span><span class=\"p\">.</span><span class=\"n\">can_id</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\">      </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">CAN_OFFSET_EMIT_ADDR</span><span class=\"w\">     </span><span class=\"o\">|</span>\n<span class=\"w\">                </span><span class=\"n\">dest</span><span class=\"w\">         </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">CAN_OFFSET_RECEIVER_ADDR</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\">                </span><span class=\"n\">functionCode</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">CAN_OFFSET_FUNCTION_CODE</span><span class=\"w\"> </span><span class=\"o\">|</span>\n<span class=\"w\">                </span><span class=\"n\">messageID</span><span class=\"w\">    </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">CAN_OFFSET_MESSAGE_ID</span><span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"w\">                </span><span class=\"n\">isResponse</span><span class=\"w\">                               </span><span class=\"o\">|</span>\n<span class=\"w\">                </span><span class=\"n\">CAN_EFF_FLAG</span><span class=\"p\">;</span>\n\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">::</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">socket</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">buffer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">sizeof</span><span class=\"p\">(</span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">can_frame</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// Erreur lors de l&#39;envoi</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n<p>Un d\u00e9tail important est que, pour utiliser la trame \u00e9tendue, il faut utiliser le flag <code>CAN_EFF_FLAG</code> dans le champ <code>can_id</code>.</p>"
}