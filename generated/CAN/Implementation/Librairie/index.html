<!DOCTYPE html>

<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Wiki Robotech Nancy - Initialisation</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Implémentation de l'initialisation du bus CAN">

		<link rel="stylesheet" href="http://127.0.0.1:8000/static/style.css">
		<link rel="apple-touch-icon" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="icon" type="image/webp" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700&display=swap">
	</head>

	<body>
		<header>
			<h1>
				<a href="http://127.0.0.1:8000/">
					<img src="http://127.0.0.1:8000/static/images/icons/logo.webp" width="40" height="40" alt="Logo Robotech Nancy">
					<span>Wiki Robotech Nancy</span>
				</a>
				<button type="button" class="open-nav" aria-label="Ouvrir la navigation" onclick="document.body.classList.toggle('nav-open')"></button>
			</h1>

			<nav>
				<div>
					
    

    <a href="http://127.0.0.1:8000/Cartes/">Cartes utilisées</a>
    

    <a href="http://127.0.0.1:8000/Wiki/">Modifier ce wiki</a>
    

    <details>
        <summary>Build avec CMake</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CMake/Installation/">Installer CMake</a>
    

    <a href="http://127.0.0.1:8000/CMake/Executable/">Créer un exécutable</a>
    

    <a href="http://127.0.0.1:8000/CMake/Lier/">Lier des librairies</a>
    

    <a href="http://127.0.0.1:8000/CMake/Librairie/">Créer une librairie</a>
    

        </div>
    </details>
    

    <details>
        <summary>Projets STM32</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/STM32/Installation/">Installation</a>
    

    <a href="http://127.0.0.1:8000/STM32/Projet/">Créer un projet</a>
    

    <a href="http://127.0.0.1:8000/STM32/CubeMX/">Configurer une carte</a>
    

        </div>
    </details>
    

    <details>
        <summary>Bus CAN</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/CAN/Raspberry/">Librairie Raspberry</a>
    

    <a href="http://127.0.0.1:8000/CAN/STM32/">Librairie STM32</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Librairie/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Modules XBee</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/XBee/Librairie/">Utiliser la librairie</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Initialisation/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Odométrie</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Odometrie/ArUCO/">Marqueurs ArUCO</a>
    

    <a href="http://127.0.0.1:8000/Odometrie/Optique/">Capteur optique</a>
    

        </div>
    </details>
    

    <details>
        <summary>Signaux PWM</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/STM32/">STM32</a>
    

    <details>
        <summary>PCA9685</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/PCA9685/Librairie/">Utiliser la librairie</a>
    

    <a href="http://127.0.0.1:8000/PWM/PCA9685/Implementation/">Implémentation</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

				</div>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>CAN/Implementation/Librairie</h2>
				<h3 class="no-anchor">Initialisation</h3>
			</div>
			<article class="content">
				<h3>Côté STM32</h3>
<p>Côté STM32, l'initialisation est très simple :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1">// Démarrer le périphérique CAN</span>
<span class="n">HAL_CAN_Start</span><span class="p">(</span><span class="n">hcan</span><span class="p">);</span>

<span class="c1">// Activer le mode interruption</span>
<span class="n">HAL_CAN_ActivateNotification</span><span class="p">(</span><span class="n">hcan</span><span class="p">,</span><span class="w"> </span><span class="n">CAN_IT_RX_FIFO0_MSG_PENDING</span><span class="p">);</span>
</code></pre></div>

<p>Grâce à la seconde fonction, on indique quelle interruption doit être utilisée lorsqu'un message est reçu.
Ici on utilise <code>CAN_IT_RX_FIFO0_MSG_PENDING</code> qui permet d'exécuter <code>HAL_CAN_RxFifo0MsgPendingCallback</code> lorsque le <code>FIFO0</code> (queue) reçoit un message.</p>
<h3>Côté Raspberry</h3>
<p>Les librairies standard Linux sont utilisées pour communiquer avec le bus CAN. D'abord, on ouvre un socket :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1">// PF = Protocol Family</span>
<span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">::</span><span class="n">socket</span><span class="p">(</span><span class="n">PF_CAN</span><span class="p">,</span><span class="w"> </span><span class="n">SOCK_RAW</span><span class="p">,</span><span class="w"> </span><span class="n">CAN_RAW</span><span class="p">);</span>

<span class="c1">// Ouverture du socket en mode non-bloquant</span>
<span class="n">fcntl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">F_SETFL</span><span class="p">,</span><span class="w"> </span><span class="n">O_NONBLOCK</span><span class="p">);</span>
</code></pre></div>

<p>Ensuite, on vérifie que l'interface est prête à être utilisée :</p>
<ul>
<li>On crée une structure <code>ifreq</code> et on lui attribue le nom de l'interface</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="n">ifreq</span><span class="w"> </span><span class="n">ifr</span><span class="p">{};</span><span class="w">                          </span><span class="c1">// ifreq = interface request</span>
<span class="n">strcpy</span><span class="p">(</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_name</span><span class="p">,</span><span class="w"> </span><span class="n">CAN_INTERFACE</span><span class="p">);</span><span class="w">  </span><span class="c1">// CAN_INTERFACE = &quot;can0&quot; ou &quot;vcan0&quot;</span>
</code></pre></div>

<ul>
<li>On vérifie que l'interface est up</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">::</span><span class="n">ioctl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">SIOCGIFFLAGS</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Impossible de récupérer les flags de l&#39;interface</span>
<span class="w">    </span><span class="c1">// donc l&#39;interface est introuvable</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">IFF_UP</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// L&#39;interface n&#39;est pas up</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li>Pour lier l'interface au bus CAN, il faut retrouver l'index de l'interface</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">::</span><span class="n">ioctl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">SIOCGIFINDEX</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ifr</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Impossible de récupérer l&#39;index de l&#39;interface</span>
<span class="p">}</span>
</code></pre></div>

<p>Maintenant que l'interface est prête, on peut la lier au socket :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="n">sockaddr_can</span><span class="w"> </span><span class="n">addr</span><span class="p">{};</span>
<span class="n">addr</span><span class="p">.</span><span class="n">can_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AF_CAN</span><span class="p">;</span>
<span class="n">addr</span><span class="p">.</span><span class="n">can_ifindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ifr</span><span class="p">.</span><span class="n">ifr_ifindex</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Impossible de lier l&#39;interface au socket</span>
<span class="p">}</span>
</code></pre></div>
			</article>
		</section>

		<script src="http://127.0.0.1:8000/static/script.js"></script>
	</body>
</html>