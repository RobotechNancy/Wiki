{
    "hidden": "false",
    "title": "Impl\u00e9mentation",
    "description": "Documentation sur l'impl\u00e9mentation de la librairie custom",
    "order": "2",
    "uri": "PWM/PCA9685/Implementation",
    "page_content": "<p>La librairie communique en I2C avec le PCA9685 pour g\u00e9n\u00e9rer les signaux PWM.\nSouvent, seuls deux octets sont envoy\u00e9s \u00e0 la carte, le registre \u00e0 \u00e9crire et la valeur \u00e0 \u00e9crire dans ce registre :</p>\n<div class=\"codehilite\"><pre tabindex='0'><span></span><code><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mh\">0x00</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mb\">0b00110000</span><span class=\"p\">};</span>\n\n<span class=\"n\">HAL_I2C_Master_Transmit</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"o\">&amp;</span><span class=\"n\">hi2c1</span><span class=\"p\">,</span><span class=\"w\">           </span><span class=\"c1\">// Interface I2C</span>\n<span class=\"w\">    </span><span class=\"n\">PCA_I2C_ADDR</span><span class=\"p\">,</span><span class=\"w\">     </span><span class=\"c1\">// Adresse de la carte (ici 0x80)</span>\n<span class=\"w\">    </span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\">             </span><span class=\"c1\">// Registre puis valeur \u00e0 \u00e9crire</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\">                </span><span class=\"c1\">// Taille des donn\u00e9es          </span>\n<span class=\"w\">    </span><span class=\"n\">PCA_I2C_TIMEOUT</span><span class=\"w\">   </span><span class=\"c1\">// Timeout</span>\n<span class=\"p\">);</span>\n</code></pre></div>\n\n<p>La carte PCA9685 permet aussi d'\u00e9crire sur plusieurs registres en une seule fois :</p>\n<div class=\"codehilite\"><pre tabindex='0'><span></span><code><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mh\">0x00</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mb\">0b00110000</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mb\">0b00100101</span><span class=\"p\">};</span>\n<span class=\"n\">HAL_I2C_Master_Transmit</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">hi2c1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">PCA_I2C_ADDR</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">PCA_I2C_TIMEOUT</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<p>Dans ce cas, la valeur <code>0b00110000</code> est \u00e9crite dans le registre <code>0x00</code> et la valeur <code>0b00100101</code> est \u00e9crite dans le registre suivant (et ainsi de suite).</p>\n<h3>Initialisation</h3>\n<p>Trois registres sont d\u00e9di\u00e9s \u00e0 la configuration du PCA9685 :</p>\n<table tabindex='0'>\n<thead>\n<tr>\n<th style=\"text-align: left;\">Nom</th>\n<th style=\"text-align: center;\">Registre</th>\n<th style=\"text-align: center;\">Valeur</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: left;\">MODE1</td>\n<td style=\"text-align: center;\">0x00</td>\n<td style=\"text-align: center;\">0b00100000</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">MODE2</td>\n<td style=\"text-align: center;\">0x01</td>\n<td style=\"text-align: center;\">0b00000000</td>\n</tr>\n<tr>\n<td style=\"text-align: left;\">PRE_SCALE</td>\n<td style=\"text-align: center;\">0xFE</td>\n<td style=\"text-align: center;\">0x79</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p>Le prescaler est d\u00e9fini pour une fr\u00e9quence de 50Hz avec la formule suivante :<br>\nD = 25MHz \u00f7 (4096*50Hz) - 1 = 121 = 0x79</p>\n</blockquote>\n<p>Les registres <code>MODE1</code> et <code>MODE2</code> sont d\u00e9finis comme suit :</p>\n<table tabindex='0'>\n<thead>\n<tr>\n<th style=\"text-align: center;\">Bit</th>\n<th style=\"text-align: center;\">Symbole</th>\n<th style=\"text-align: left;\">Description</th>\n<th style=\"text-align: center;\">Valeur</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">7</td>\n<td style=\"text-align: center;\">RESTART</td>\n<td style=\"text-align: left;\">Red\u00e9marrage activ\u00e9</td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">6</td>\n<td style=\"text-align: center;\">EXTCLK</td>\n<td style=\"text-align: left;\">Utilisation d'un clock externe</td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">5</td>\n<td style=\"text-align: center;\">AI</td>\n<td style=\"text-align: left;\">Ecriture des registres avec incr\u00e9mentation automatique</td>\n<td style=\"text-align: center;\">1</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">4</td>\n<td style=\"text-align: center;\">SLEEP</td>\n<td style=\"text-align: left;\">Mode veille, activ\u00e9 pour d\u00e9finir le prescaler</td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">3</td>\n<td style=\"text-align: center;\">SUB1</td>\n<td style=\"text-align: left;\">La carte ne r\u00e9agit pas \u00e0 la sous-adresse 1</td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">2</td>\n<td style=\"text-align: center;\">SUB2</td>\n<td style=\"text-align: left;\">La carte ne r\u00e9agit pas \u00e0 la sous-adresse 2</td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1</td>\n<td style=\"text-align: center;\">SUB3</td>\n<td style=\"text-align: left;\">La carte ne r\u00e9agit pas \u00e0 la sous-adresse 3</td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">0</td>\n<td style=\"text-align: center;\">ALLCALL</td>\n<td style=\"text-align: left;\">La carte ne r\u00e9agit pas aux appels All Call</td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n</tbody>\n</table>\n<table tabindex='0'>\n<thead>\n<tr>\n<th style=\"text-align: center;\">Bit</th>\n<th style=\"text-align: center;\">Symbole</th>\n<th style=\"text-align: left;\">Description</th>\n<th style=\"text-align: center;\">Valeur</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align: center;\">7 - 5</td>\n<td style=\"text-align: center;\">-</td>\n<td style=\"text-align: left;\">R\u00e9serv\u00e9s</td>\n<td style=\"text-align: center;\">000</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">4</td>\n<td style=\"text-align: center;\">INVRT</td>\n<td style=\"text-align: left;\">L'\u00e9tat logique des sorties n'est pas invers\u00e9</td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">3</td>\n<td style=\"text-align: center;\">OCH</td>\n<td style=\"text-align: left;\">Voir page 16 de la <a href=\"https://cdn-shop.adafruit.com/datasheets/PCA9685.pdf\">datasheet</a></td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">2</td>\n<td style=\"text-align: center;\">OUTDRV</td>\n<td style=\"text-align: left;\">Les sorties sont en mode open-drain</td>\n<td style=\"text-align: center;\">0</td>\n</tr>\n<tr>\n<td style=\"text-align: center;\">1 - 0</td>\n<td style=\"text-align: center;\">OUTNE0</td>\n<td style=\"text-align: left;\">Voir page 16 de la <a href=\"https://cdn-shop.adafruit.com/datasheets/PCA9685.pdf\">datasheet</a></td>\n<td style=\"text-align: center;\">00</td>\n</tr>\n</tbody>\n</table>\n<p>On utilise <code>AI</code> pour d\u00e9sactiver toutes les sorties puis on d\u00e9finit la valeur du prescaler :</p>\n<ul>\n<li>\u00c9crire <code>0b00110000</code> dans le registre <code>MODE1</code> pour activer le bit <code>SLEEP</code> et le bit <code>AI</code></li>\n<li>\u00c9crire <code>0x79</code> dans le registre <code>0xFE</code> pour d\u00e9finir le prescaler</li>\n<li>\u00c9crire <code>0b00100000</code> dans le registre <code>MODE1</code> pour d\u00e9sactiver le bit <code>SLEEP</code></li>\n</ul>\n<h3>Contr\u00f4le des sorties</h3>\n<p>Toutes les fonctions li\u00e9es au contr\u00f4le des sorties renvoient un code d'erreur si la sortie demand\u00e9e n'existe pas ou si la valeur demand\u00e9e est en dehors des limites.</p>\n<p>Pour d\u00e9finir un compte, une r\u00e8gle de trois est utilis\u00e9e :</p>\n<div class=\"codehilite\"><pre tabindex='0'><span></span><code><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">on_count</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">points</span><span class=\"p\">,</span><span class=\"w\">         </span><span class=\"c1\">// Valeur \u00e0 convertir</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\">              </span><span class=\"c1\">// Minimum en entr\u00e9e</span>\n<span class=\"w\">    </span><span class=\"n\">PCA_PWM_RANGE</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// Maximum en entr\u00e9e</span>\n<span class=\"w\">    </span><span class=\"n\">PCA_PWM_MIN</span><span class=\"p\">,</span><span class=\"w\">    </span><span class=\"c1\">// Minimum en sortie</span>\n<span class=\"w\">    </span><span class=\"n\">PCA_PWM_MAX</span><span class=\"w\">     </span><span class=\"c1\">// Maximum en sortie</span>\n<span class=\"p\">);</span>\n</code></pre></div>\n\n<p>Similairement pour un cycle de travail :</p>\n<div class=\"codehilite\"><pre tabindex='0'><span></span><code><span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">points</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">uint16_t</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">duty_cycle</span><span class=\"o\">*</span><span class=\"n\">PCA_PWM_RANGE</span><span class=\"p\">);</span>\n\n<span class=\"kt\">uint16_t</span><span class=\"w\"> </span><span class=\"n\">on_count</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">map</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">points</span><span class=\"p\">,</span><span class=\"w\">         </span><span class=\"c1\">// Valeur \u00e0 convertir</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\">              </span><span class=\"c1\">// Minimum en entr\u00e9e</span>\n<span class=\"w\">    </span><span class=\"n\">PCA_PWM_RANGE</span><span class=\"p\">,</span><span class=\"w\">  </span><span class=\"c1\">// Maximum en entr\u00e9e</span>\n<span class=\"w\">    </span><span class=\"n\">PCA_PWM_MIN</span><span class=\"p\">,</span><span class=\"w\">    </span><span class=\"c1\">// Minimum en sortie</span>\n<span class=\"w\">    </span><span class=\"n\">PCA_PWM_MAX</span><span class=\"w\">     </span><span class=\"c1\">// Maximum en sortie</span>\n<span class=\"p\">);</span>\n</code></pre></div>\n\n<p>Une fois le compte <code>ON</code> calcul\u00e9, on le s\u00e9pare en deux octets et on les \u00e9crit dans les registres <code>LEDn_ON_L</code> et <code>LEDn_ON_H</code> :</p>\n<div class=\"codehilite\"><pre tabindex='0'><span></span><code><span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mi\">0</span><span class=\"n\">x</span><span class=\"o\">??</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"n\">x</span><span class=\"o\">??</span><span class=\"p\">};</span>\n<span class=\"n\">PCA9685_write_data</span><span class=\"p\">(</span><span class=\"n\">i2c</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">PCA_REG_CHAN0_OFF_L</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">channel</span><span class=\"o\">*</span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">);</span>\n</code></pre></div>\n\n<p>Il y a quatre registres par canal, deux pour le compte <code>ON</code> et deux pour le compte <code>OFF</code> donc on part du registre <code>LEDn_ON_L</code> et on ajoute <code>channel*4</code> pour obtenir le registre <code>LEDn_ON_L</code> du canal demand\u00e9.</p>\n<p>Similairement pour \u00e9teindre une sortie :</p>\n<div class=\"codehilite\"><pre tabindex='0'><span></span><code><span class=\"c1\">// Ces valeurs correspondent \u00e0 LEDn full OFF</span>\n<span class=\"kt\">uint8_t</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"mh\">0x00</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mh\">0x10</span><span class=\"p\">};</span>\n<span class=\"n\">PCA9685_write_data</span><span class=\"p\">(</span><span class=\"n\">i2c</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">PCA_REG_CHAN0_OFF_L</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">channel</span><span class=\"o\">*</span><span class=\"mi\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">);</span>\n</code></pre></div>"
}