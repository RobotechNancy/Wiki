<!DOCTYPE html>

<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Wiki Robotech Nancy - Implémentation</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Documentation sur l'implémentation de la librairie custom">

		<link rel="stylesheet" href="http://127.0.0.1:8000/static/style.css">
		<link rel="apple-touch-icon" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="icon" type="image/webp" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700&display=swap">
	</head>

	<body>
		<header>
			<h1>
				<a href="http://127.0.0.1:8000/">
					<img src="http://127.0.0.1:8000/static/images/icons/logo.webp" width="40" height="40" alt="Logo Robotech Nancy">
					<span>Wiki Robotech Nancy</span>
				</a>
				<button type="button" class="open-nav" aria-label="Ouvrir la navigation" onclick="document.body.classList.toggle('nav-open')"></button>
			</h1>

			<nav>
				<div>
					
    

    <a href="http://127.0.0.1:8000/Cartes/">Cartes utilisées</a>
    

    <a href="http://127.0.0.1:8000/Wiki/">Modifier ce wiki</a>
    

    <details>
        <summary>Build avec CMake</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CMake/Installation/">Installer CMake</a>
    

    <a href="http://127.0.0.1:8000/CMake/Executable/">Créer un exécutable</a>
    

    <a href="http://127.0.0.1:8000/CMake/Lier/">Lier des librairies</a>
    

    <a href="http://127.0.0.1:8000/CMake/Librairie/">Créer une librairie</a>
    

        </div>
    </details>
    

    <details>
        <summary>Projets STM32</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/STM32/Installation/">Installation</a>
    

    <a href="http://127.0.0.1:8000/STM32/Projet/">Créer un projet</a>
    

    <a href="http://127.0.0.1:8000/STM32/CubeMX/">Configurer une carte</a>
    

        </div>
    </details>
    

    <details>
        <summary>Bus CAN</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/CAN/Raspberry/">Librairie Raspberry</a>
    

    <a href="http://127.0.0.1:8000/CAN/STM32/">Librairie STM32</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Librairie/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Modules XBee</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/XBee/Librairie/">Utiliser la librairie</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Initialisation/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Odométrie</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Odometrie/ArUCO/">Marqueurs ArUCO</a>
    

    <a href="http://127.0.0.1:8000/Odometrie/Optique/">Capteur optique</a>
    

        </div>
    </details>
    

    <details>
        <summary>Signaux PWM</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/STM32/">STM32</a>
    

    <details>
        <summary>PCA9685</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/PCA9685/Librairie/">Utiliser la librairie</a>
    

    <a href="http://127.0.0.1:8000/PWM/PCA9685/Implementation/">Implémentation</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

				</div>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>PWM/PCA9685/Implementation</h2>
				<h3 class="no-anchor">Implémentation</h3>
			</div>
			<article class="content">
				<p>La librairie communique en I2C avec le PCA9685 pour générer les signaux PWM.
Souvent, seuls deux octets sont envoyés à la carte, le registre à écrire et la valeur à écrire dans ce registre :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mb">0b00110000</span><span class="p">};</span>

<span class="n">HAL_I2C_Master_Transmit</span><span class="p">(</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">hi2c1</span><span class="p">,</span><span class="w">           </span><span class="c1">// Interface I2C</span>
<span class="w">    </span><span class="n">PCA_I2C_ADDR</span><span class="p">,</span><span class="w">     </span><span class="c1">// Adresse de la carte (ici 0x80)</span>
<span class="w">    </span><span class="n">data</span><span class="p">,</span><span class="w">             </span><span class="c1">// Registre puis valeur à écrire</span>
<span class="w">    </span><span class="mi">2</span><span class="p">,</span><span class="w">                </span><span class="c1">// Taille des données          </span>
<span class="w">    </span><span class="n">PCA_I2C_TIMEOUT</span><span class="w">   </span><span class="c1">// Timeout</span>
<span class="p">);</span>
</code></pre></div>

<p>La carte PCA9685 permet aussi d'écrire sur plusieurs registres en une seule fois :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mb">0b00110000</span><span class="p">,</span><span class="w"> </span><span class="mb">0b00100101</span><span class="p">};</span>
<span class="n">HAL_I2C_Master_Transmit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hi2c1</span><span class="p">,</span><span class="w"> </span><span class="n">PCA_I2C_ADDR</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">PCA_I2C_TIMEOUT</span><span class="p">);</span>
</code></pre></div>

<p>Dans ce cas, la valeur <code>0b00110000</code> est écrite dans le registre <code>0x00</code> et la valeur <code>0b00100101</code> est écrite dans le registre suivant (et ainsi de suite).</p>
<h3>Initialisation</h3>
<p>Trois registres sont dédiés à la configuration du PCA9685 :</p>
<table tabindex='0'>
<thead>
<tr>
<th style="text-align: left;">Nom</th>
<th style="text-align: center;">Registre</th>
<th style="text-align: center;">Valeur</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">MODE1</td>
<td style="text-align: center;">0x00</td>
<td style="text-align: center;">0b00100000</td>
</tr>
<tr>
<td style="text-align: left;">MODE2</td>
<td style="text-align: center;">0x01</td>
<td style="text-align: center;">0b00000000</td>
</tr>
<tr>
<td style="text-align: left;">PRE_SCALE</td>
<td style="text-align: center;">0xFE</td>
<td style="text-align: center;">0x79</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Le prescaler est défini pour une fréquence de 50Hz avec la formule suivante :<br>
D = 25MHz ÷ (4096*50Hz) - 1 = 121 = 0x79</p>
</blockquote>
<p>Les registres <code>MODE1</code> et <code>MODE2</code> sont définis comme suit :</p>
<table tabindex='0'>
<thead>
<tr>
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Symbole</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Valeur</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">7</td>
<td style="text-align: center;">RESTART</td>
<td style="text-align: left;">Redémarrage activé</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">6</td>
<td style="text-align: center;">EXTCLK</td>
<td style="text-align: left;">Utilisation d'un clock externe</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">5</td>
<td style="text-align: center;">AI</td>
<td style="text-align: left;">Ecriture des registres avec incrémentation automatique</td>
<td style="text-align: center;">1</td>
</tr>
<tr>
<td style="text-align: center;">4</td>
<td style="text-align: center;">SLEEP</td>
<td style="text-align: left;">Mode veille, activé pour définir le prescaler</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">3</td>
<td style="text-align: center;">SUB1</td>
<td style="text-align: left;">La carte ne réagit pas à la sous-adresse 1</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: center;">SUB2</td>
<td style="text-align: left;">La carte ne réagit pas à la sous-adresse 2</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">SUB3</td>
<td style="text-align: left;">La carte ne réagit pas à la sous-adresse 3</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">ALLCALL</td>
<td style="text-align: left;">La carte ne réagit pas aux appels All Call</td>
<td style="text-align: center;">0</td>
</tr>
</tbody>
</table>
<table tabindex='0'>
<thead>
<tr>
<th style="text-align: center;">Bit</th>
<th style="text-align: center;">Symbole</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Valeur</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">7 - 5</td>
<td style="text-align: center;">-</td>
<td style="text-align: left;">Réservés</td>
<td style="text-align: center;">000</td>
</tr>
<tr>
<td style="text-align: center;">4</td>
<td style="text-align: center;">INVRT</td>
<td style="text-align: left;">L'état logique des sorties n'est pas inversé</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">3</td>
<td style="text-align: center;">OCH</td>
<td style="text-align: left;">Voir page 16 de la <a href="https://cdn-shop.adafruit.com/datasheets/PCA9685.pdf">datasheet</a></td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: center;">OUTDRV</td>
<td style="text-align: left;">Les sorties sont en mode open-drain</td>
<td style="text-align: center;">0</td>
</tr>
<tr>
<td style="text-align: center;">1 - 0</td>
<td style="text-align: center;">OUTNE0</td>
<td style="text-align: left;">Voir page 16 de la <a href="https://cdn-shop.adafruit.com/datasheets/PCA9685.pdf">datasheet</a></td>
<td style="text-align: center;">00</td>
</tr>
</tbody>
</table>
<p>On utilise <code>AI</code> pour désactiver toutes les sorties puis on définit la valeur du prescaler :</p>
<ul>
<li>Écrire <code>0b00110000</code> dans le registre <code>MODE1</code> pour activer le bit <code>SLEEP</code> et le bit <code>AI</code></li>
<li>Écrire <code>0x79</code> dans le registre <code>0xFE</code> pour définir le prescaler</li>
<li>Écrire <code>0b00100000</code> dans le registre <code>MODE1</code> pour désactiver le bit <code>SLEEP</code></li>
</ul>
<h3>Contrôle des sorties</h3>
<p>Toutes les fonctions liées au contrôle des sorties renvoient un code d'erreur si la sortie demandée n'existe pas ou si la valeur demandée est en dehors des limites.</p>
<p>Pour définir un compte, une règle de trois est utilisée :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="kt">uint16_t</span><span class="w"> </span><span class="n">on_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">(</span>
<span class="w">    </span><span class="n">points</span><span class="p">,</span><span class="w">         </span><span class="c1">// Valeur à convertir</span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">              </span><span class="c1">// Minimum en entrée</span>
<span class="w">    </span><span class="n">PCA_PWM_RANGE</span><span class="p">,</span><span class="w">  </span><span class="c1">// Maximum en entrée</span>
<span class="w">    </span><span class="n">PCA_PWM_MIN</span><span class="p">,</span><span class="w">    </span><span class="c1">// Minimum en sortie</span>
<span class="w">    </span><span class="n">PCA_PWM_MAX</span><span class="w">     </span><span class="c1">// Maximum en sortie</span>
<span class="p">);</span>
</code></pre></div>

<p>Similairement pour un cycle de travail :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="kt">uint16_t</span><span class="w"> </span><span class="n">points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">duty_cycle</span><span class="o">*</span><span class="n">PCA_PWM_RANGE</span><span class="p">);</span>

<span class="kt">uint16_t</span><span class="w"> </span><span class="n">on_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="p">(</span>
<span class="w">    </span><span class="n">points</span><span class="p">,</span><span class="w">         </span><span class="c1">// Valeur à convertir</span>
<span class="w">    </span><span class="mi">0</span><span class="p">,</span><span class="w">              </span><span class="c1">// Minimum en entrée</span>
<span class="w">    </span><span class="n">PCA_PWM_RANGE</span><span class="p">,</span><span class="w">  </span><span class="c1">// Maximum en entrée</span>
<span class="w">    </span><span class="n">PCA_PWM_MIN</span><span class="p">,</span><span class="w">    </span><span class="c1">// Minimum en sortie</span>
<span class="w">    </span><span class="n">PCA_PWM_MAX</span><span class="w">     </span><span class="c1">// Maximum en sortie</span>
<span class="p">);</span>
</code></pre></div>

<p>Une fois le compte <code>ON</code> calculé, on le sépare en deux octets et on les écrit dans les registres <code>LEDn_ON_L</code> et <code>LEDn_ON_H</code> :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="n">x</span><span class="o">??</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">x</span><span class="o">??</span><span class="p">};</span>
<span class="n">PCA9685_write_data</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span><span class="w"> </span><span class="n">PCA_REG_CHAN0_OFF_L</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">channel</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</code></pre></div>

<p>Il y a quatre registres par canal, deux pour le compte <code>ON</code> et deux pour le compte <code>OFF</code> donc on part du registre <code>LEDn_ON_L</code> et on ajoute <code>channel*4</code> pour obtenir le registre <code>LEDn_ON_L</code> du canal demandé.</p>
<p>Similairement pour éteindre une sortie :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1">// Ces valeurs correspondent à LEDn full OFF</span>
<span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">};</span>
<span class="n">PCA9685_write_data</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span><span class="w"> </span><span class="n">PCA_REG_CHAN0_OFF_L</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">channel</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</code></pre></div>
			</article>
		</section>

		<script src="http://127.0.0.1:8000/static/script.js"></script>
	</body>
</html>