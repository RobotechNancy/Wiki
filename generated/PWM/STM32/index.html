<!DOCTYPE html>

<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Wiki Robotech Nancy - STM32</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Comment générer un signal PWM sur un microcontrôleur STM32">

		<link rel="stylesheet" href="http://127.0.0.1:8000/static/style.css">
		<link rel="apple-touch-icon" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="icon" type="image/webp" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700&display=swap">
	</head>

	<body>
		<header>
			<h1>
				<a href="http://127.0.0.1:8000/">
					<img src="http://127.0.0.1:8000/static/images/icons/logo.webp" width="40" height="40" alt="Logo Robotech Nancy">
					<span>Wiki Robotech Nancy</span>
				</a>
				<button type="button" class="open-nav" aria-label="Ouvrir la navigation" onclick="document.body.classList.toggle('nav-open')"></button>
			</h1>

			<nav>
				<div>
					
    

    <a href="http://127.0.0.1:8000/Cartes/">Cartes utilisées</a>
    

    <a href="http://127.0.0.1:8000/Wiki/">Modifier ce wiki</a>
    

    <details>
        <summary>Build avec CMake</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CMake/Installation/">Installer CMake</a>
    

    <a href="http://127.0.0.1:8000/CMake/Executable/">Créer un exécutable</a>
    

    <a href="http://127.0.0.1:8000/CMake/Lier/">Lier des librairies</a>
    

    <a href="http://127.0.0.1:8000/CMake/Librairie/">Créer une librairie</a>
    

        </div>
    </details>
    

    <details>
        <summary>Projets STM32</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/STM32/Installation/">Installation</a>
    

    <a href="http://127.0.0.1:8000/STM32/Projet/">Créer un projet</a>
    

    <a href="http://127.0.0.1:8000/STM32/CubeMX/">Configurer une carte</a>
    

        </div>
    </details>
    

    <details>
        <summary>Bus CAN</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/CAN/Raspberry/">Librairie Raspberry</a>
    

    <a href="http://127.0.0.1:8000/CAN/STM32/">Librairie STM32</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Librairie/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Modules XBee</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/XBee/Librairie/">Utiliser la librairie</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Initialisation/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Odométrie</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Odometrie/ArUCO/">Marqueurs ArUCO</a>
    

    <a href="http://127.0.0.1:8000/Odometrie/Optique/">Capteur optique</a>
    

        </div>
    </details>
    

    <details>
        <summary>Signaux PWM</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/STM32/">STM32</a>
    

    <details>
        <summary>PCA9685</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/PCA9685/Librairie/">Utiliser la librairie</a>
    

    <a href="http://127.0.0.1:8000/PWM/PCA9685/Implementation/">Implémentation</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

				</div>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>PWM/STM32</h2>
				<h3 class="no-anchor">STM32</h3>
			</div>
			<article class="content">
				<p>Le PWM (Pulse Width Modulation) consiste à moduler la largeur d'une impulsion pour contrôler la puissance moyenne délivrée à un composant.
C'est un signal carré dont le rapport cyclique (temps haut / temps total) est variable :
<img alt="PWM" src="http://127.0.0.1:8000/static/images/pwm/signals.webp" /></p>
<p>Deux paramètres sont à prendre en compte :</p>
<ul>
<li>La fréquence du signal : elle est fixe et dépend du composant (ex : 50Hz pour un servo-moteur analogique)</li>
<li>Le temps haut du signal : il est variable et fixe le rapport pour chaque cycle</li>
</ul>
<h3>Paramétrage de la carte</h3>
<p>Avant de régler le timer, il faut configurer la clock que va utiliser le timer (menu <code>Clock Configuration</code>).
Ici, on utilise le timer <code>TIM1</code> qui est sur le bus <code>APB2</code> et qui a une fréquence de 4MHz :
<img alt="Prescaler clock" loading="lazy" src="http://127.0.0.1:8000/static/images/pwm/clock_config.webp" /></p>
<blockquote>
<p class="quote quote-TIP">Pour trouver quelle clock le timer utilise, il faut regarder la <a href="https://www.st.com/resource/en/datasheet/stm32l432kc.pdf">datasheet</a> du microcontrôleur, dans la section  <code>Memory mapping</code> (ici, page 60).</p>
</blockquote>
<p>Ensuite, on peut régler le timer TIM1 qu'on utilisera pour générer le signal PWM.
Ici, l'objectif était d'avoir trois signaux, d'où le mode PWM sur 3 channels :
<img alt="TIM1" loading="lazy" src="http://127.0.0.1:8000/static/images/pwm/timer_config.webp" /></p>
<p>Il est aussi nécessaire de calculer la valeur du prescaler à partir de la clock (4MHz), 
du compteur utilisé (4096) et de la fréquence voulue (50Hz) : <code>4MHz ÷ (4096*50Hz) - 1 = 18</code>.</p>
<h3>Génération du signal</h3>
<p>Pour commencer la génération du signal, il faut utiliser la fonction <code>HAL_TIM_PWM_Start</code> :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1">// htim1 et TIM_CHANNEL_X sont automatiquement générés par CubeMX</span>
<span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_1</span><span class="p">);</span>
<span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_2</span><span class="p">);</span>
<span class="n">HAL_TIM_PWM_Start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_3</span><span class="p">);</span>
</code></pre></div>

<p>Maintenant que le signal est généré, il est possible de modifier le compte de chaque channel :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="n">htim1</span><span class="p">.</span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">CCR1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">205</span><span class="p">;</span><span class="w"> </span><span class="c1">// Channel 1</span>
<span class="n">htim1</span><span class="p">.</span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">CCR2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">410</span><span class="p">;</span><span class="w"> </span><span class="c1">// Channel 2</span>
<span class="n">htim1</span><span class="p">.</span><span class="n">Instance</span><span class="o">-&gt;</span><span class="n">CCR3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">615</span><span class="p">;</span><span class="w"> </span><span class="c1">// Channel 3</span>
</code></pre></div>

<p>Enfin, pour arrêter la génération du signal, il faut utiliser la fonction <code>HAL_TIM_PWM_Stop</code> :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="n">HAL_TIM_PWM_Stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_1</span><span class="p">);</span>
<span class="n">HAL_TIM_PWM_Stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_2</span><span class="p">);</span>
<span class="n">HAL_TIM_PWM_Stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htim1</span><span class="p">,</span><span class="w"> </span><span class="n">TIM_CHANNEL_3</span><span class="p">);</span>
</code></pre></div>
			</article>
		</section>

		<script src="http://127.0.0.1:8000/static/script.js"></script>
	</body>
</html>