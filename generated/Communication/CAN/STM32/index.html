<!DOCTYPE html>

<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Wiki Robotech Nancy - Librairie STM32</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Utiliser la librairie CAN pour STM32">

		<link rel="stylesheet" href="http://127.0.0.1:8000/static/style.css">
		<link rel="apple-touch-icon" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="icon" type="image/webp" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700&display=swap">
	</head>

	<body>
		<header>
			<h1>
				<a href="http://127.0.0.1:8000/">
					<img src="http://127.0.0.1:8000/static/images/icons/logo.webp" width="40" height="40" alt="Logo Robotech Nancy">
					<span>Wiki Robotech Nancy</span>
				</a>
				<button type="button" class="open-nav" aria-label="Ouvrir la navigation" onclick="document.body.classList.toggle('nav-open')"></button>
			</h1>

			<nav>
				<div>
					
    

    <a href="http://127.0.0.1:8000/Cartes/">Cartes utilisées</a>
    

    <a href="http://127.0.0.1:8000/Wiki/">Modifier ce wiki</a>
    

    <details>
        <summary>CMake</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CMake/Installation/">Installer CMake</a>
    

    <a href="http://127.0.0.1:8000/CMake/Executable/">Créer un exécutable</a>
    

    <a href="http://127.0.0.1:8000/CMake/Lier/">Lier des librairies</a>
    

    <a href="http://127.0.0.1:8000/CMake/Librairie/">Créer une librairie</a>
    

        </div>
    </details>
    

    <details>
        <summary>STM32</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/STM32/Installation/">Installation</a>
    

    <a href="http://127.0.0.1:8000/STM32/Projet/">Créer un projet</a>
    

    <a href="http://127.0.0.1:8000/STM32/CubeMX/">Configurer une carte</a>
    

        </div>
    </details>
    

    <details>
        <summary>Communication</summary>
        <div>
            
    <details>
        <summary>XBee</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Communication/XBee/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/Communication/XBee/Librairie/">Utiliser la librairie</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Communication/XBee/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/Communication/XBee/Implementation/Initialisation/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/Communication/XBee/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/Communication/XBee/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>CAN</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Communication/CAN/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/Communication/CAN/Raspberry/">Librairie Raspberry</a>
    

    <a href="http://127.0.0.1:8000/Communication/CAN/STM32/">Librairie STM32</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Communication/CAN/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/Communication/CAN/Implementation/Librairie/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/Communication/CAN/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/Communication/CAN/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

        </div>
    </details>
    

				</div>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>Communication/CAN/STM32</h2>
				<h3 class="no-anchor">Librairie STM32</h3>
			</div>
			<article class="content">
				<p>Pour importer la librairie CAN dans un projet STM32, il faut :</p>
<ul>
<li>Depuis la racine du projet : <code>git clone https://github.com/RobotechNancy/CAN-L432KC.git</code></li>
<li>Suivre <a href="https://www.youtube.com/watch?v=MUZj4YwKVac">cette démarche</a>, qui se résume à<ul>
<li>Aller dans <code>Project &gt; Properties &gt; C/C++ General &gt; Paths and Symbols</code></li>
<li>Ajouter le dossier <code>CAN-L432KC/Inc</code> dans l'onglet <code>Include</code></li>
<li>Ajouter le dossier <code>CAN-L432KC</code> dans l'onglet <code>Source Location</code></li>
</ul>
</li>
</ul>
<blockquote>
<p class="quote quote-TIP">Pour mettre à jour la librairie, <code>git pull</code> dans le dossier cloné.</p>
</blockquote>
<h3>Configuration du bus</h3>
<p>La configuration du bus se fait dans le fichier <code>ioc</code> du projet STM32 :</p>
<ul>
<li>Ouvrir le fichier <code>ioc</code> du projet STM32</li>
<li>Dans l'onglet <code>Pinout &amp; Configuration</code>, sélectionner <code>CAN1</code> dans <code>Connectivity</code></li>
<li>Cocher <code>Activated</code> dans <code>CAN1 Mode and Configuration</code></li>
<li>Cocher toutes les interruptions dans <code>NVIC Settings</code>
<img alt="Screenshot IOC" src="http://127.0.0.1:8000/static/images/CAN/IOC.webp" /></li>
</ul>
<p>Les pins <code>CAN1_RX</code> et <code>CAN1_TX</code> sont configurées automatiquement (ici, <code>PA11</code> et <code>PA12</code>).
Pour le baudrate, il est automatiquement calculé en fonction des paramètres dans <code>Bit Timings Parameters</code>.</p>
<h3>Initialisation</h3>
<p>La fonction <code>CAN_START</code> permet d'attribuer une adresse et d'initialiser le bus CAN :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="cm">/* USER CODE BEGIN 2 */</span>
<span class="n">CAN_START</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcan1</span><span class="p">,</span><span class="w"> </span><span class="n">CAN_ADDR_ODOMETRIE</span><span class="p">);</span>
<span class="cm">/* USER CODE END 2 */</span>
</code></pre></div>

<blockquote>
<p class="quote quote-WARNING">Il faut placer cette fonction dans le main avant la boucle infinie et dans
une section <code>USER CODE</code> pour ne pas qu'elle soit écrasée lors de la génération</p>
</blockquote>
<h3>Envoyer des données</h3>
<p>La fonction <code>CAN_SEND</code> permet d'envoyer des données sur le bus CAN, par exemple :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mh">0x01</span><span class="w"> </span><span class="p">};</span>

<span class="n">HAL_StatusTypeDef</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CAN_SEND</span><span class="p">(</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">hcan1</span><span class="p">,</span><span class="w">                  </span><span class="c1">// Structure créée par CubeMX pour gérer le bus CAN</span>
<span class="w">    </span><span class="n">CAN_ADDR_RASPBERRY</span><span class="p">,</span><span class="w">      </span><span class="c1">// Adresse du destinataire</span>
<span class="w">    </span><span class="n">FCT_ACCUSER_RECEPTION</span><span class="p">,</span><span class="w">   </span><span class="c1">// Fonction à appeler sur le destinataire</span>
<span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">                       </span><span class="c1">// Identifiant de la trame applicative</span>
<span class="w">    </span><span class="nb">false</span><span class="p">,</span><span class="w">                   </span><span class="c1">// Demande =&gt; false</span>
<span class="w">    </span><span class="n">data</span><span class="p">,</span><span class="w">                    </span><span class="c1">// Données à envoyer </span>
<span class="w">    </span><span class="mi">1</span><span class="w">                        </span><span class="c1">// Taille des données</span>
<span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Erreur dans l&#39;envoi</span>
<span class="p">}</span>
</code></pre></div>

<h3>Recevoir des données</h3>
<p>Pour recevoir des données, il faut créer la fonction <code>HAL_CAN_RxFifo0MsgPendingCallback</code> qui sera automatiquement appelée à chaque trame reçue
et utiliser <code>CAN_RECEIVE</code> pour récupérer les données :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">HAL_CAN_RxFifo0MsgPendingCallback</span><span class="p">(</span><span class="n">CAN_HandleTypeDef</span><span class="w"> </span><span class="o">*</span><span class="n">hcan</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">can_frame_t</span><span class="w"> </span><span class="n">frame</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CAN_RECEIVE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hcan1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">HAL_OK</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Erreur dans la réception</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Utiliser frame</span>
<span class="p">}</span>
</code></pre></div>
			</article>
		</section>

		<script src="http://127.0.0.1:8000/static/script.js"></script>
	</body>
</html>