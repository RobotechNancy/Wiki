<!DOCTYPE html>

<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Wiki Robotech Nancy - Utiliser la librairie</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="description" content="Comment utiliser la librairie XBee sur une Raspberry Pi">

		<link rel="stylesheet" href="http://127.0.0.1:8000/static/style.css">
		<link rel="apple-touch-icon" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="icon" type="image/webp" href="http://127.0.0.1:8000/static/images/icons/logo.webp">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700&display=swap">
	</head>

	<body>
		<header>
			<h1>
				<a href="http://127.0.0.1:8000/">
					<img src="http://127.0.0.1:8000/static/images/icons/logo.webp" width="40" height="40" alt="Logo Robotech Nancy">
					<span>Wiki Robotech Nancy</span>
				</a>
				<button type="button" class="open-nav" aria-label="Ouvrir la navigation" onclick="document.body.classList.toggle('nav-open')"></button>
			</h1>

			<nav>
				<div>
					
    

    <a href="http://127.0.0.1:8000/Cartes/">Cartes utilisées</a>
    

    <a href="http://127.0.0.1:8000/Wiki/">Modifier ce wiki</a>
    

    <details>
        <summary>Build avec CMake</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CMake/Installation/">Installer CMake</a>
    

    <a href="http://127.0.0.1:8000/CMake/Executable/">Créer un exécutable</a>
    

    <a href="http://127.0.0.1:8000/CMake/Lier/">Lier des librairies</a>
    

    <a href="http://127.0.0.1:8000/CMake/Librairie/">Créer une librairie</a>
    

        </div>
    </details>
    

    <details>
        <summary>Projets STM32</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/STM32/Installation/">Installation</a>
    

    <a href="http://127.0.0.1:8000/STM32/Projet/">Créer un projet</a>
    

    <a href="http://127.0.0.1:8000/STM32/CubeMX/">Configurer une carte</a>
    

        </div>
    </details>
    

    <details>
        <summary>Bus CAN</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/CAN/Raspberry/">Librairie Raspberry</a>
    

    <a href="http://127.0.0.1:8000/CAN/STM32/">Librairie STM32</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/CAN/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Librairie/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/CAN/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Modules XBee</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Principe/">Principe</a>
    

    <a href="http://127.0.0.1:8000/XBee/Librairie/">Utiliser la librairie</a>
    

    <details>
        <summary>Implémentation</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/XBee/Implementation/Format/">Format des trames</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Initialisation/">Initialisation</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Reception/">Réception de données</a>
    

    <a href="http://127.0.0.1:8000/XBee/Implementation/Envoi/">Envoi de données</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

    <details>
        <summary>Odométrie</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/Odometrie/ArUCO/">Marqueurs ArUCO</a>
    

    <a href="http://127.0.0.1:8000/Odometrie/Optique/">Capteur optique</a>
    

        </div>
    </details>
    

    <details>
        <summary>Signaux PWM</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/STM32/">STM32</a>
    

    <details>
        <summary>PCA9685</summary>
        <div>
            
    <a href="http://127.0.0.1:8000/PWM/PCA9685/Librairie/">Utiliser la librairie</a>
    

    <a href="http://127.0.0.1:8000/PWM/PCA9685/Implementation/">Implémentation</a>
    

        </div>
    </details>
    

        </div>
    </details>
    

				</div>
			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>XBee/Librairie</h2>
				<h3 class="no-anchor">Utiliser la librairie</h3>
			</div>
			<article class="content">
				<p>La librairie XBee est utilisable uniquement sur Linux, pour l'installer :</p>
<ul>
<li>Clôner le dépôt GitHub : <code>git clone https://github.com/RobotechNancy/Communication.git</code></li>
<li>Se placer dans le dossier cloné : <code>cd Communication</code></li>
<li>Utiliser le script d'installation : <code>sudo ./lib_manager install Logs XBee</code></li>
</ul>
<blockquote>
<p class="quote quote-TIP">Pour mettre à jour la librairie, <code>git pull</code> puis <code>sudo ./lib_manager install XBee</code></p>
</blockquote>
<h3>Initialisation</h3>
<p>Pour initialiser un module XBee, il faut créer une instance de la classe <code>XBee</code> :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1">// Adresses 8 bits (0x00 à 0xFF) ou macro XB_ADDR_&lt;...&gt;</span>
<span class="n">XBee</span><span class="w"> </span><span class="nf">xbee</span><span class="p">(</span><span class="n">XB_ADDR_ROBOT_01</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xbee</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/ttyAMA0&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">9600</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Une erreur s&#39;est produite lors de l&#39;ouverture du port série</span>
<span class="w">    </span><span class="c1">// Toutes les erreurs sont définies dans define_xbee.h</span>
<span class="p">}</span>
</code></pre></div>

<p>En fonction d'où est utilisé la librairie, le port série peut être différent.
Par exemple, sur une Raspberry Pi, c'est généralement <code>/dev/ttyAMA0</code> alors que sur PC c'est généralement un des ports USB (ex. <code>/dev/ttyUSB0</code>).</p>
<p>Si une mauvaise configuration est à l'origine d'une erreur d'initialisation, vous pouvez utiliser <a href="https://www.digi.com/products/embedded-systems/digi-xbee/digi-xbee-tools/xctu">XCTU</a> pour la corriger. La librairie utilise les paramètres par défauts d'un module XBee.</p>
<blockquote>
<p class="quote quote-TIP">Si vous utiliser l'adaptateur USB, il est possible de réinitialiser la configuration en appuyant sur le bouton reset.</p>
</blockquote>
<h3>Envoyer des données</h3>
<p>Pour envoyer des données, il suffit d'utiliser la fonction <code>XBee::send</code>:</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1">// On envoie un octet avec le code fonction TEST_ALIVE à la caméra 01</span>
<span class="n">xbee</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">XB_ADDR_CAMERA_01</span><span class="p">,</span><span class="w"> </span><span class="n">XB_FCT_TEST_ALIVE</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="mh">0x01</span><span class="p">});</span>

<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">};</span>
<span class="n">xbee</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">XB_ADDR_CAMERA_02</span><span class="p">,</span><span class="w"> </span><span class="n">XB_FCT_TEST_ALIVE</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">);</span>
</code></pre></div>

<p>Il est possible d'envoyer jusqu'à 243 octets de données, la fonction retourne un code d'erreur le cas echéant.</p>
<h3>Recevoir des données</h3>
<p>Il existe deux moyens de recevoir des données :</p>
<ul>
<li>De manière synchrone (bloque le programme) avec <code>XBee::send</code> :</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="c1">// On veut récupérer toutes les positions</span>
<span class="c1">// avec un délai maximal de 5 secondes</span>
<span class="n">xbee_result_t</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xbee</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">XB_ADDR_01</span><span class="p">,</span><span class="w"> </span><span class="n">XB_FCT_GET_ARUCO_POS</span><span class="p">,</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>

<span class="k">switch</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">XB_E_SUCCESS</span><span class="p">:</span>
<span class="w">        </span><span class="c1">// Trame disponible avec res.frame</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Positions reçues !&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">XB_E_FRAME_TIMEOUT</span><span class="p">:</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Aucune réponse reçue en 5 secondes&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Une erreur est survenue :(&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li>De manière asynchrone (non bloquant) avec <code>XBee::bind</code> :</li>
</ul>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">onTestAlive</span><span class="p">(</span><span class="n">XBee</span><span class="w"> </span><span class="o">&amp;</span><span class="n">xbee</span><span class="p">,</span><span class="w"> </span><span class="n">xbee_frame_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Code fonction TEST_ALIVE reçu&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">xbee</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">emitterAddress</span><span class="p">,</span><span class="w"> </span><span class="n">XB_FCT_TEST_ALIVE</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">xbee</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">XB_FCT_TEST_ALIVE</span><span class="p">,</span><span class="w"> </span><span class="n">onTestAlive</span><span class="p">);</span>
</code></pre></div>

<p>Dans les deux cas, il faut utiliser <code>XBee::startListening</code> pour pouvoir recevoir des données, par exemple :</p>
<div class="codehilite"><pre tabindex='0'><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;robotech/xbee.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">XBee</span><span class="w"> </span><span class="n">xbee</span><span class="p">(</span><span class="n">XB_ADDR_ROBOT_01</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xbee</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/ttyUSB0&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">XB_E_SUCCESS</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Utilisation d&#39;un lambda au lieu d&#39;une fonction classique</span>
<span class="w">    </span><span class="n">xbee</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">XB_FCT_TEST_ALIVE</span><span class="p">,</span><span class="w"> </span><span class="p">[](</span><span class="n">XBee</span><span class="w"> </span><span class="o">&amp;</span><span class="n">xbee</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">xbee_frame_t</span><span class="w"> </span><span class="o">&amp;</span><span class="n">frame</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Code fonction TEST_ALIVE reçu&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="n">xbee</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">frame</span><span class="p">.</span><span class="n">emitterAddress</span><span class="p">,</span><span class="w"> </span><span class="n">XB_FCT_TEST_ALIVE</span><span class="p">,</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="c1">// On bloque le thread principal pour laisser le </span>
<span class="w">    </span><span class="c1">// temps au programme de recevoir des meesages</span>
<span class="w">    </span><span class="n">xbee</span><span class="p">.</span><span class="n">startListening</span><span class="p">();</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
			</article>
		</section>

		<script src="http://127.0.0.1:8000/static/script.js"></script>
	</body>
</html>